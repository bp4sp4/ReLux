<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/default}">

<section layout:fragment="contents">
	<div class="wrap">
		<div>
			<div class="wrap__interface">
				<div class="wrap__interface__login">
					<h1 class="login__title">회원가입</h1>
					<p class="login__title__subtitle">가입을 위해 필수 정보를 입력해 주세요.</p>
					<div class="textbox">
						<label class="textbox__subtitle">아이디<span style="color : red;">*</span></label>
						<input type="text" class="idcheck" placeholder="아이디를 입력해주세요." required id="idInput">
						<button type="button" id="duplicateBtn">중복확인</button>
					</div>
					<div class="duplicate__contents">
						<div class="textblue d-none" id="availableText">사용 가능한 ID입니다.</div>
						<div class="textred d-none" id="duplicateText">중복된 ID입니다.</div>
					</div>
					<div class="textbox">
						<label class="textbox__subtitle">비밀번호<span style="color : red;">*</span></label>
						<input type="password" placeholder="8~16자리 대소문자 특수문자 포함" required id="passwordInput">
						<i id="togglePassword" class="fa fa-eye toggle__password" aria-hidden="true"></i>
					</div>
					<div class="textbox">
						<label class="textbox__subtitle">비밀번호 확인<span style="color : red;">*</span></label>
						<input type="password" placeholder="비밀번호 확인" required id="passwordConfirmInput">
					</div>
					<div class="password__check">
						<div class="textblue d-none" id="passwordMatchText">비밀번호가 일치합니다.</div>
						<div class="textred d-none" id="passwordMismatchText">비밀번호가 일치하지 않습니다.</div>
					</div>
					<div class="textbox">
						<label class="textbox__subtitle">이름<span style="color : red;">*</span></label>
						<input type="text" placeholder="홍길동" required id="nameInput">
					</div>
					<div class="textbox">
						<label class="textbox__subtitle">이메일<span style="color : red;">*</span></label>
						<input type="text" placeholder="abc@relux.com" required id="emailInput">
					</div>
					<button type="button" class="btn" id="joinBtn">가입하기</button>
				</div>
			</div>
		</div>
	</div>
</section>

<script layout:fragment="script">
$(document).ready(function() {
    let checkDuplicate = false;
    let isDuplicateId = true;

    // 필수 입력 필드 확인 함수
    function checkRequiredFields() {
        const id = $("#idInput").val().trim();
        const password = $("#passwordInput").val().trim();
        const passwordConfirm = $("#passwordConfirmInput").val().trim();
        const name = $("#nameInput").val().trim();
        const email = $("#emailInput").val().trim();

        if (id && password && passwordConfirm && name && email && checkDuplicate && !isDuplicateId) {
            $("#joinBtn").prop("disabled", false);
        } else {
            $("#joinBtn").prop("disabled", true);
        }
    }
    
    function validatePassword(password) {
        const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,16}$/;
        return regex.test(password);
    }


    $("#idInput").on("input", function() {
        checkDuplicate = false;
        isDuplicateId = true;
        $("#availableText").addClass("d-none");
        $("#duplicateText").addClass("d-none");
        $("#joinBtn").prop("disabled", true);
        checkRequiredFields();
    });

    $("#duplicateBtn").on("click", function() {
        let id = $("#idInput").val().trim();
        if (id === "") {
            alert("아이디를 입력하세요");
            return;
        }

        $.ajax({
            type: "get",
            url: "/user/duplicate-id",
            data: { "loginId": id },
            success: function(data) {
                checkDuplicate = true;
                isDuplicateId = data.isDuplicate;
                if (data.isDuplicate) {
                    $("#duplicateText").removeClass("d-none");
                    $("#availableText").addClass("d-none");
                    $("#joinBtn").prop("disabled", true); 
                } else {
                    $("#availableText").removeClass("d-none");
                    $("#duplicateText").addClass("d-none");
                    checkRequiredFields();
                }
            },
            error: function() {
                alert("중복 확인 에러!");
            }
        });
    });

    $("#passwordInput, #passwordConfirmInput, #nameInput, #emailInput").on("input", function() {
        checkRequiredFields(); 
    });

    $("#passwordInput, #passwordConfirmInput").on("input", function() {
        let password = $("#passwordInput").val().trim();
        let passwordConfirm = $("#passwordConfirmInput").val().trim();

        if (!validatePassword(password)) {
            $("#passwordMismatchText").removeClass("d-none").text("비밀번호 형식이 맞지 않습니다.");
            $("#passwordMatchText").addClass("d-none");
            return;
        }

        if (password === passwordConfirm) {
            $("#passwordMatchText").removeClass("d-none");
            $("#passwordMismatchText").addClass("d-none");
        } else {
            $("#passwordMismatchText").removeClass("d-none").text("비밀번호가 일치하지 않습니다.");
            $("#passwordMatchText").addClass("d-none");
        }
    });

    $("#joinBtn").on("click", function() {
        $(this).prop("disabled", true);

        let id = $("#idInput").val().trim();
        let password = $("#passwordInput").val().trim();
        let passwordConfirm = $("#passwordConfirmInput").val().trim();
        let name = $("#nameInput").val().trim();
        let email = $("#emailInput").val().trim();

        if (id === "" || password === "" || passwordConfirm === "" || name === "" || email === "") {
            alert("모든 필수 정보를 입력하세요");
            return;
        }

        if (!checkDuplicate) {
            alert("아이디 중복확인을 해주세요");
            return;
        }

        if (isDuplicateId) {
            alert("아이디가 중복되었습니다");
            return;
        }

        if (!validatePassword(password)) {
            alert("비밀번호 형식이 맞지 않습니다");
            return;
        }

        if (password !== passwordConfirm) {
            alert("비밀번호가 일치하지 않습니다");
            return;
        }

        $.ajax({
            type: "post",
            url: "/user/join",
            data: { "loginId": id, "password": password, "name": name, "email": email },
            success: function(data) {
                if (data.result == "success") {
                    location.href = "/user/login-view";
                } else {
                    alert("회원가입 실패!");
                }
            },
            error: function() {
                alert("회원가입 에러!");
            }
        });
    });

    $("#togglePassword").on("click", function() {
        let passwordInput = $("#passwordInput");
        let type = passwordInput.attr("type") === "password" ? "text" : "password";
        passwordInput.attr("type", type);
        $(this).toggleClass("fa-eye fa-eye-slash");
    });

    $("#joinBtn").prop("disabled", true);
});
</script>

</html>
