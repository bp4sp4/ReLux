<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/default}">

<head>
<meta charset="UTF-8">
<title>게시글 상세</title>
<script>
        // userId를 Thymeleaf에서 가져와서 JavaScript 변수로 설정
        var userId = /*[[${session.userId}]]*/ null; // 세션에서 userId를 가져옵니다.
    </script>
</head>

<body>
	<section layout:fragment="contents">
		<main class="post__wrap__detail">
			<!-- 수정, 삭제, 목록 버튼 -->
			<div class="post__wrap__commonBtn">
				<a href="/post/list-view" class="post__wrap__detail__list">목록</a> <a
					th:if="${session.userId == post.userId}"
					th:href="@{/post/update-view/{id}(id=${post.id})}"
					class="post__wrap__detail__modify">수정</a> <a href="#"
					th:if="${session.userId == post.userId}"
					th:onclick="'deletePost(' + ${post.id} + ')'"
					class="post__wrap__detail__delete">삭제</a>
			</div>

			<!-- 글의 상단 영역 -->
			<div class="post__wrap__info">
				<h1 class="post__wrap__info__title" th:text="${post.title}">제목이
					없습니다</h1>
				<div class="post__wrap__info__sellerinfo">
					<div class="post__wrap__info__seller" th:text="${user.name}">판매자
						정보가 없습니다</div>
					<div class="post__wrap__info__time"
						th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">작성
						시간이 없습니다</div>
					<div class="post__wrap__info__viewer"
						th:text="'조회수: ' + ${viewCount}">조회수: 5</div>
				</div>
				<img th:if="${post.imagePath != null}" th:src="@{${post.imagePath}}"
					alt="게시글 이미지" />
				<div class="post__wrap__content" th:text="${cleanedContents}">내용이
					없습니다</div>
			</div>

			<!-- 글의 댓글 영역 -->
			<div class="post__wrap__reply">
				<ul class="post__wrap__reply__list">
					<li th:each="comment : ${comments}"
						class="post__wrap__reply__items">
						<div class="post__wrap__replyer">
							<span th:text="${comment.userName}">작성자</span>
							<div
								th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm:ss')}"
								class="post__wrap__replyer__time">2024-10-11 19:24:01</div>
							<div class="post__wrap__reply__items__btn">
								<!-- 댓글 수정 버튼 -->
								<a href="#" class="reply__update"
									th:data-comment-id="${comment.id}"
									th:if="${session.userId == comment.userId}">수정</a>
								<!-- 댓글 삭제 버튼 -->
								<a href="#" class="reply__delete"
									th:data-comment-id="${comment.id}"
									th:if="${session.userId == comment.userId}"
									th:onclick="'deleteComment(' + ${comment.id} + ', ' + ${session.userId} + ')'">삭제</a>
							</div>
						</div>
						<div th:text="${comment.contents}"
							class="post__wrap__reply__items__contents">댓글 내용</div>
					</li>
				</ul>

				<!-- 댓글 작성 영역 -->
				<div class="post__wrap__reply__article">
					<textarea id="commentContents" cols="30" rows="10"
						placeholder="로그인 후 댓글 작성이 가능합니다"
						th:readonly="${session.userId == null}"></textarea>
					<div class="post__wrap__reply__confirm">
						<a href="#" id="createBtn" th:data-post-id="${post.id}">등록</a>
					</div>
				</div>
			</div>

		</main>
	</section>

	<script layout:fragment="script">
        $(document).ready(function () {
            // 댓글 등록 버튼 클릭 시
            $('#createBtn').on('click', function () {
                let postId = $(this).data('post-id');
                let contents = $('#commentContents').val();

                if (contents.trim() === "") {
                    alert("댓글 내용을 입력하세요");
                    return;
                }

                // AJAX로 댓글 작성 요청
                $.ajax({
                    type: "POST",
                    url: "/comment/create",
                    data: {
                        postId: postId,
                        contents: contents,
                        userId: userId 
                    },
                    success: function (response) {
                        if (response.result === "success") {
                            alert("댓글이 등록되었습니다.");
                            location.reload(); // 페이지 새로고침
                        } else {
                            alert("댓글 작성 실패");
                        }
                    },
                    error: function () {
                        alert("댓글 작성 중 오류 발생!");
                    }
                });
            });

            // 댓글 삭제 함수 정의
            window.deleteComment = function(commentId, userId) {
                if (confirm("댓글을 삭제하시겠습니까?")) {
                    $.ajax({
                        type: "POST",
                        url: "/comment/delete",
                        data: {
                            commentId: commentId,
                            userId: userId 
                        },
                        success: function(response) {
                            if (response.result === "success") {
                                alert("댓글이 삭제되었습니다.");
                                location.reload(); // 페이지 새로고침
                            } else {
                                alert("댓글 삭제 실패: " + response.message);
                            }
                        },
                        error: function() {
                            alert("댓글 삭제 중 오류 발생!");
                        }
                    });
                }
            }
            
            window.deletePost = function(postId, userId) {
                if (confirm("게시글을 삭제하시겠습니까?")) {
                    $.ajax({
                        type: "POST",
                        url: "/post/delete",
                        data: {
                            postId: postId,
                            userId: userId 
                        },
                        success: function(response) {
                            if (response.result === "success") {
                                alert("게시글이 삭제되었습니다.");
                                location.href = "/post/list-view"; // 목록 페이지로 이동
                            } else {
                                alert("게시글 삭제 실패: " + response.message);
                            }
                        },
                        error: function() {
                            alert("게시글 삭제 중 오류 발생!");
                        }
                    });
                }
            }
        });
    </script>

</body>
</html>
